<%- include("blogHeaderYouPost.ejs") %>

<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Blog Posts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div class="container my-5">
    <h1 class="mb-4 text-center">Your Blog</h1>

    <!-- Login / Logout Info -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <% if (currentUser) { %>
        <div class="boxingText" style="color: #DCD7C9; font-size: x-large;">
          Logged in as <strong><%= currentUser %></strong>
        </div>
        <form action="/logout" method="POST">
          <button type="submit" class="btn btn-danger btn-sm">Logout</button>
        </form>
      <% } else { %>
        <a href="/login" class="btn btn-primary btn-login">Login to create/manage posts</a>
      <% } %>
    </div>

    <!-- Post Creation Form -->
    <% if (currentUser) { %>
      <div class="card mb-5" style="background-color: #DCD7C9;">
        <div class="card-header">
          <h4 style="color: #A27B5C;">Create a New Post</h4>
        </div>
        <div class="card-body">
          <form action="/posts" method="POST">
            <div class="mb-3">
              <label for="title" class="form-label" style="color: #A27B5C;">Title</label>
              <input
                type="text" 
                class="form-control" 
                id="title" 
                name="title" 
                placeholder="Enter post title" 
                required
              />
            </div>
            <div class="mb-3">
              <label for="content" class="form-label" style="color: #A27B5C;">Content</label>
              <textarea 
                class="form-control" 
                id="content" 
                name="content" 
                rows="4" 
                placeholder="Write your post content here..." 
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary btncreate">Create Post</button>
          </form>
        </div>
      </div>
    <% } %>

    <!-- Posts Listing -->
     <div class="boxingText mb-4 d-flex justify-content-between align-items-center">
        <h2>All Posts</h2>
    </div>
    <% if (posts && posts.length > 0) { %> 
      <div class="row row-cols-1 row-cols-md-2 g-4">
        <% posts.forEach(post => { %>
          <div class="col">
            <div class="card h-100" style="background-color: #DCD7C9;">
              <div class="card-body d-flex flex-column post">
              <h5 class="card-title post-title" style="color:black"><%= post.title %></h5>
              <p class="card-text post-content" style="color: #A27B5C; font-weight: bold;"><%= post.content %></p>
                <small style="color: #6c757d;">by <%= post.author %></small>

                <div class="mt-auto d-flex justify-content-between editDelete">
                  <% if (
                    currentUser && 
                    (currentUser === post.author || currentUser === ADMIN_USERNAME)
                  ) { %>
                    <!-- Edit button opens the edit form -->
                    <button 
                      class="btn btn-sm btn-outline-secondary" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#editForm-<%= post._id %>" 
                      aria-expanded="false" 
                      aria-controls="editForm-<%= post._id %>"
                    >
                      Edit
                    </button>

                    <!-- Delete form -->
                    <form 
                      action="/posts/<%= post._id %>?_method=DELETE" 
                      method="POST" 
                      onsubmit="return confirm('Are you sure you want to delete this post?');"
                    >
                      <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  <% } %>
                </div>

                <!-- Edit form collapse -->
                <% if (
                  currentUser && 
                  (currentUser === post.author || currentUser === ADMIN_USERNAME)
                ) { %>
                  <div class="collapse mt-3" id="editForm-<%= post._id %>">
                    <form action="/posts/<%= post._id %>?_method=PUT" method="POST">
                      <div class="mb-2">
                        <input 
                          type="text" 
                          name="title" 
                          class="form-control" 
                          value="<%= post.title %>" 
                          required
                        />
                      </div>
                      <div class="mb-2">
                        <textarea 
                          name="content" 
                          class="form-control" 
                          rows="3" 
                          required
                        ><%= post.content %></textarea>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Save Changes</button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p style="color: #DCD7C9;">No posts yet. Start by creating your first post!</p>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
